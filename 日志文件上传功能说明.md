# 日志文件上传功能说明

## 功能概述

在用例执行结束后，系统会自动将执行过程中的控制台输出保存到日志文件中，并上传到gohttpserver，生成可访问的HTTP链接。

## 功能特性

### 1. 日志文件存储
- 日志文件存储在固定的`logs`目录下
- 文件命名格式：`{用例ID}_{轮次}.log`
- 例如：`1_1.log`、`2_3.log`

### 2. 自动上传到gohttpserver
- 用例执行完成后自动上传日志文件
- 使用gohttpserver的原生HTTP上传接口
- 生成可访问的文件URL

### 3. 动态gohttpserver地址
- gohttpserver地址通过`logReportUrl`字段传递
- 支持动态配置不同的gohttpserver服务器
- 兼容现有的日志上报机制

## 技术实现

### 1. 修改的文件

#### CaseExecuteService
- `PythonExecutorUtil.java`: 添加日志文件上传功能
- `GoHttpServerClient.java`: 新增HTTP客户端工具类
- `TestCaseExecutionServiceImpl.java`: 传递gohttpserver地址
- `TestCaseExecutionRequest.java`: 使用logReportUrl传递gohttpserver地址

#### DataCollectService
- `CollectTaskProcessServiceImpl.java`: 提取gohttpserver地址并传递给CaseExecuteService

### 2. 核心代码逻辑

#### 日志文件创建
```java
// 创建日志目录
Path logsDir = Path.of(projectDir, "logs");
if (!Files.exists(logsDir)) {
    Files.createDirectories(logsDir);
}

// 创建日志文件路径
String logFileName = String.format("%d_%d.log", testCaseId, round);
Path logFilePath = logsDir.resolve(logFileName);

// 重定向输出到日志文件
processBuilder.redirectOutput(logFilePath.toFile());
```

#### 日志文件上传
```java
// 上传日志文件到gohttpserver
if (goHttpServerUrl != null && !goHttpServerUrl.trim().isEmpty()) {
    GoHttpServerClient goHttpServerClient = new GoHttpServerClient();
    uploadedLogUrl = goHttpServerClient.uploadLocalFile(logFilePath.toString(), logFileName, goHttpServerUrl);
    log.info("日志文件上传成功 - 用例ID: {}, 轮次: {}, 上传URL: {}", testCaseId, round, uploadedLogUrl);
}
```

#### gohttpserver地址传递
```java
// 从用例集路径中提取gohttpserver地址
String goHttpServerUrl = null;
if (testCaseSetPath != null && testCaseSetPath.startsWith("http")) {
    int uploadIndex = testCaseSetPath.indexOf("/upload/");
    if (uploadIndex > 0) {
        goHttpServerUrl = testCaseSetPath.substring(0, uploadIndex);
    }
}

// 使用gohttpserver地址作为日志上报URL
if (goHttpServerUrl != null && !goHttpServerUrl.trim().isEmpty()) {
    request.setLogReportUrl(goHttpServerUrl);
}
```

## 使用流程

### 1. 创建采集任务
- 在DataCollectService中创建采集任务
- 系统自动提取gohttpserver地址

### 2. 调用CaseExecuteService
- DataCollectService调用CaseExecuteService
- 通过`logReportUrl`字段传递gohttpserver地址

### 3. 执行用例
- CaseExecuteService执行Python脚本
- 控制台输出保存到本地日志文件

### 4. 上传日志文件
- 用例执行完成后自动上传日志文件
- 生成可访问的HTTP链接

### 5. 返回结果
- 执行结果中的`logFileName`字段包含上传后的URL
- 可以通过该URL访问日志文件

## 配置说明

### gohttpserver配置
- 确保gohttpserver服务正常运行
- 支持HTTP上传接口：`POST /upload`
- 文件访问URL格式：`http://{server}:{port}/upload/{filename}`

### 日志目录配置
- 默认日志目录：`CaseExecuteService/logs/`
- 目录不存在时自动创建
- 日志文件永久保存，不自动清理

## 错误处理

### 1. gohttpserver不可用
- 记录警告日志
- 不影响用例执行流程
- 返回本地日志文件路径

### 2. 文件上传失败
- 记录错误日志
- 继续执行后续流程
- 返回本地日志文件路径

### 3. 网络异常
- 超时处理（60秒）
- 重试机制
- 降级到本地存储

## 测试验证

### 1. 测试脚本
```bash
# 运行测试脚本
python3 test_log_upload.py
```

### 2. 测试用例
```json
{
  "taskId": "LOG_UPLOAD_TEST_001",
  "executorIp": "localhost",
  "testCaseSetId": 1,
  "testCaseSetPath": "http://localhost:8000/upload/test_log_upload.zip",
  "testCaseList": [
    {
      "testCaseId": 1,
      "testCaseNumber": "TC001",
      "round": 1
    }
  ],
  "resultReportUrl": "http://localhost:8080/api/test-result/report",
  "logReportUrl": "http://localhost:8000"
}
```

### 3. 验证步骤
1. 启动gohttpserver服务
2. 调用CaseExecuteService接口
3. 检查logs目录中的日志文件
4. 验证gohttpserver中的上传文件
5. 访问生成的HTTP链接

## 注意事项

1. **文件大小限制**: 确保gohttpserver支持上传文件大小
2. **并发处理**: 大量并发执行时注意性能影响
3. **存储空间**: 定期清理不需要的日志文件
4. **网络稳定性**: 确保网络连接稳定，避免上传失败

## 相关文件

- `PythonExecutorUtil.java`: 核心执行逻辑
- `GoHttpServerClient.java`: HTTP客户端工具
- `test_log_upload.py`: 测试脚本
- `test_log_upload_example.json`: 测试用例
- `logs/`: 日志文件存储目录
