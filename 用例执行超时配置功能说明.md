# 用例执行超时配置功能说明

## 功能概述

用例执行服务现在支持通过配置文件设置单个用例执行超时时长，当执行超时时，**CaseExecuteService会自动终止这个用例执行**，将用例状态置为Error，并在失败原因中包含time out信息。

## 配置说明

### 配置文件位置
- 主配置文件：`src/main/resources/application.yml`
- 测试配置文件：`test_timeout_config.yml`

### 配置项
```yaml
case:
  execution:
    # 单个用例执行超时时长（分钟），默认1分钟
    timeout-minutes: 1
```

### 配置示例

#### 默认配置（1分钟超时）
```yaml
case:
  execution:
    timeout-minutes: 1
```

#### 快速测试配置（30秒超时）
```yaml
case:
  execution:
    timeout-minutes: 0.5
```

#### 长时间测试配置（5分钟超时）
```yaml
case:
  execution:
    timeout-minutes: 5
```

#### 超长测试配置（30分钟超时）
```yaml
case:
  execution:
    timeout-minutes: 30
```

## 核心特性

### 1. 自动终止机制 ⭐
- **自动检测超时**: 系统自动监控用例执行时间
- **强制终止进程**: 超时时自动终止Python进程及其子进程
- **进程树清理**: 确保所有相关进程都被正确终止
- **资源释放**: 防止僵尸进程和资源泄漏

### 2. 可配置超时时间
- 支持通过配置文件动态设置超时时间
- 默认超时时间为1分钟
- 支持小数分钟配置（如0.5分钟 = 30秒）

### 3. 超时处理机制
- 当用例执行超过配置的超时时间时，自动终止执行
- 将用例状态设置为 `ERROR`
- 在失败原因中包含超时信息：`"用例执行超时: 超过配置的超时时间 X 分钟"`

### 4. 日志记录
- 记录超时事件的详细信息
- 包含用例ID、用例编号、轮次、超时时间等信息
- 记录进程终止过程，便于问题排查和监控

## 实现细节

### 核心类
1. **CaseExecutionConfig** - 配置类，读取超时配置
2. **PythonExecutorUtil** - 工具类，支持超时参数执行Python脚本，实现自动终止
3. **TestCaseExecutionServiceImpl** - 服务实现类，使用配置的超时时间

### 关键方法
- `PythonExecutorUtil.executePythonScript(scriptPath, testCaseId, round, timeoutMinutes)` - 带超时参数的脚本执行方法
- `process.waitFor(timeoutMinutes, TimeUnit.MINUTES)` - 进程超时等待
- `terminateProcessAndChildren(process)` - 强制终止进程及其子进程 ⭐
- `terminateProcessTreeUnix(pid)` - Unix系统进程树终止
- `terminateProcessJava(process)` - Java API进程终止

### 自动终止流程 ⭐
1. **超时检测**: `process.waitFor()` 检测到超时
2. **进程终止**: 调用 `terminateProcessAndChildren()` 方法
3. **系统适配**: 根据操作系统选择终止策略
   - **Unix/macOS**: 使用 `pkill` 和 `kill -9` 命令终止进程树
   - **Windows**: 使用Java API `destroy()` 和 `destroyForcibly()`
4. **状态设置**: 将用例状态设置为 `ERROR`
5. **日志记录**: 记录终止过程和结果

### 状态处理
- **SUCCESS**: 用例执行成功
- **FAILED**: 用例执行失败（非超时原因）
- **ERROR**: 用例执行超时（自动终止）⭐
- **BLOCKED**: 用例执行被阻塞（如脚本文件不存在、Python环境问题等）

## 使用说明

### 1. 修改配置
编辑 `src/main/resources/application.yml` 文件，修改 `case.execution.timeout-minutes` 值。

### 2. 重启服务
修改配置后需要重启服务使配置生效。

### 3. 监控日志
通过日志监控用例执行情况，超时事件会记录在日志中。

## 注意事项

1. **超时时间设置建议**
   - 根据用例的复杂程度和预期执行时间合理设置
   - 避免设置过短导致正常用例被误判为超时
   - 避免设置过长导致问题用例长时间占用资源

2. **资源管理**
   - 超时的进程会被强制终止，确保不会占用过多系统资源
   - 临时文件会被自动清理

3. **监控建议**
   - 定期检查超时用例的日志
   - 分析超时原因，优化用例或调整超时配置

## 测试验证

可以通过以下方式验证超时功能：

1. **设置短超时时间**（如0.1分钟）测试超时机制
2. **查看日志**确认超时事件被正确记录
3. **检查状态上报**确认超时用例状态为ERROR
4. **验证失败原因**确认包含time out信息
