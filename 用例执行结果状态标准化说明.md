# 用例执行结果状态标准化说明

## 概述

根据需求，CaseExecuteService执行完用例后，result只有3种状态：SUCCESS、FAILED、BLOCKED。本文档说明了相关的代码修改和状态映射规则。

## 状态定义

### 1. SUCCESS（成功）
- **定义**: 用例执行完全成功，所有测试项都通过
- **触发条件**: 
  - 日志中包含"PASS"、"SUCCESS"、"成功"等标识
  - 失败测试数为0，错误测试数为0

### 2. FAILED（失败）
- **定义**: 用例执行失败，包括部分失败、超时、执行错误等
- **触发条件**:
  - 日志中包含"FAIL"、"ERROR"、"失败"等标识
  - 用例执行超时
  - 部分成功但存在失败项
  - Python脚本退出码不为0（非环境问题）

### 3. BLOCKED（阻塞）
- **定义**: 用例执行被阻塞，通常由环境问题导致
- **触发条件**:
  - Python环境问题（ImportError、ModuleNotFoundError等）
  - 文件权限问题（Permission denied）
  - 文件不存在（No such file）
  - 网络连接问题（Connection refused、Network unreachable）
  - 系统资源问题（Out of memory、Disk space不足）

## 代码修改

### 1. TestCaseResultParser.java
- 修改`parseExecutionStatus`方法
- 移除`PARTIAL_SUCCESS`、`PARTIAL_FAILURE`、`TIMEOUT`等状态
- 将超时归类为`FAILED`
- 将部分成功归类为`FAILED`
- 增强环境问题检测，归类为`BLOCKED`

### 2. PythonExecutorUtil.java
- 修改状态处理逻辑
- 将超时状态从`ERROR`改为`FAILED`
- 添加`isBlockedByEnvironment`方法检测环境问题
- 根据环境问题将状态设置为`BLOCKED`

### 3. TestCaseExecutionServiceImpl.java
- 移除对`ERROR`状态的特殊处理
- 简化状态处理流程
- 修改`reportTestCaseResult`方法，只处理`FAILED`和`BLOCKED`状态

### 4. 实体类和DTO
- 更新`TestCaseResultReport`、`TestCaseExecutionResult`等类的注释
- 将状态说明从`(SUCCESS/FAILED/TIMEOUT)`改为`(SUCCESS/FAILED/BLOCKED)`

## 状态映射规则

### 原有状态到新状态的映射
| 原有状态 | 新状态 | 说明 |
|---------|--------|------|
| SUCCESS | SUCCESS | 保持不变 |
| PARTIAL_SUCCESS | FAILED | 部分成功归类为失败 |
| FAILED | FAILED | 保持不变 |
| PARTIAL_FAILURE | FAILED | 部分失败归类为失败 |
| TIMEOUT | FAILED | 超时归类为失败 |
| ERROR | FAILED | 错误归类为失败 |
| BLOCKED | BLOCKED | 保持不变 |

### 环境问题检测
系统会自动检测以下环境问题并将其归类为`BLOCKED`：
- Python模块导入错误
- 文件权限问题
- 文件不存在
- 网络连接问题
- 系统资源不足

## 影响范围

### 1. 前端显示
- 前端需要更新状态显示逻辑，只显示3种状态
- 状态颜色和图标需要相应调整

### 2. 数据库
- 现有数据中的`TIMEOUT`、`PARTIAL_SUCCESS`等状态需要迁移
- 建议执行数据迁移脚本

### 3. 报表统计
- 统计逻辑需要更新，将部分成功、超时等状态归类到失败统计中
- 阻塞状态单独统计

## 数据迁移建议

建议执行以下SQL语句迁移现有数据：

```sql
-- 将TIMEOUT状态改为FAILED
UPDATE test_case_execution_instance 
SET result = 'FAILED' 
WHERE result = 'TIMEOUT';

-- 将PARTIAL_SUCCESS状态改为FAILED
UPDATE test_case_execution_instance 
SET result = 'FAILED' 
WHERE result = 'PARTIAL_SUCCESS';

-- 将PARTIAL_FAILURE状态改为FAILED
UPDATE test_case_execution_instance 
SET result = 'FAILED' 
WHERE result = 'PARTIAL_FAILURE';

-- 将ERROR状态改为FAILED
UPDATE test_case_execution_instance 
SET result = 'FAILED' 
WHERE result = 'ERROR';
```

## 测试建议

1. **单元测试**: 测试各种状态解析逻辑
2. **集成测试**: 测试完整的用例执行流程
3. **数据迁移测试**: 在测试环境验证数据迁移脚本
4. **前端兼容性测试**: 确保前端能正确显示新的状态

## 注意事项

1. 修改后需要重新部署CaseExecuteService
2. 建议在测试环境先验证修改效果
3. 数据迁移前需要备份数据库
4. 前端可能需要相应更新状态显示逻辑
