# 超时功能测试指南

## 测试准备

### 1. 配置超时时间
编辑 `src/main/resources/application.yml`，设置较短的超时时间进行测试：

```yaml
case:
  execution:
    timeout-minutes: 0.1  # 设置为6秒超时
```

### 2. 准备测试脚本
使用提供的 `test_timeout_script.py` 脚本，该脚本会执行指定时间的睡眠。

### 3. 启动服务
```bash
mvn spring-boot:run
```

## 测试步骤

### 测试1：正常执行（不超时）
1. 修改 `test_timeout_script.py` 中的睡眠时间为5秒
2. 设置配置超时时间为10秒
3. 执行脚本，验证正常完成

### 测试2：超时执行
1. 修改 `test_timeout_script.py` 中的睡眠时间为30秒
2. 设置配置超时时间为10秒
3. 执行脚本，验证10秒后被超时终止

### 测试3：快速超时测试
1. 设置配置超时时间为0.1分钟（6秒）
2. 执行睡眠10秒的脚本
3. 验证6秒后被超时终止

## 验证要点

### 1. 日志验证
检查服务日志，应该看到：
```
使用配置的超时时间执行用例 - 用例ID: xxx, 用例编号: xxx, 轮次: xxx, 超时时间: x分钟
用例执行超时 - 用例ID: xxx, 用例编号: xxx, 轮次: xxx, 超时时间: x分钟
开始终止进程及其子进程 - PID: xxx
已终止进程树 - PID: xxx
```

### 2. 状态验证
超时的用例状态应该为 `ERROR`

### 3. 失败原因验证
失败原因应该包含：`"用例执行超时: 超过配置的超时时间 X 分钟"`

### 4. 进程验证 ⭐
超时后，Python进程及其子进程应该被强制终止：
```bash
# 检查进程是否还存在
ps aux | grep python
ps aux | grep test_timeout_script

# 检查进程树
pstree -p | grep python
```

### 5. 进程终止验证
使用 `test_timeout_termination.py` 脚本测试进程树终止：
```bash
# 设置短超时时间（如10秒）
# 执行包含子进程的测试脚本
python3 test_timeout_termination.py 30

# 验证主进程和子进程都被终止
ps aux | grep test_timeout_termination
```

## 测试命令示例

### 直接测试Python脚本
```bash
# 测试5秒执行（应该正常完成）
python3 test_timeout_script.py 5

# 测试30秒执行（应该被超时终止）
python3 test_timeout_script.py 30
```

### 通过API测试
```bash
# 发送测试请求
curl -X POST http://localhost:8081/api/test-case-execution \
  -H "Content-Type: application/json" \
  -d @test_timeout_example.json
```

## 常见问题排查

### 1. 超时时间不生效
- 检查配置文件是否正确加载
- 确认服务已重启
- 查看启动日志中的配置信息

### 2. 进程未正确终止
- 检查 `process.destroyForcibly()` 是否被调用
- 查看系统进程列表确认Python进程已终止

### 3. 状态上报异常
- 检查网络连接
- 查看HTTP请求日志
- 确认上报URL可访问

## 性能测试

### 1. 并发超时测试
同时执行多个超时用例，验证：
- 超时机制在并发情况下正常工作
- 系统资源使用合理
- 日志记录准确

### 2. 长时间运行测试
设置较长的超时时间（如30分钟），验证：
- 系统稳定性
- 内存使用情况
- 日志文件大小

## 配置建议

### 生产环境配置
```yaml
case:
  execution:
    timeout-minutes: 5  # 5分钟超时，适合大多数用例
```

### 测试环境配置
```yaml
case:
  execution:
    timeout-minutes: 1  # 1分钟超时，快速发现问题
```

### 开发环境配置
```yaml
case:
  execution:
    timeout-minutes: 0.5  # 30秒超时，快速迭代测试
```
